sourceV0611="https://repl.it/@mgmchenry/Stormworks-Quad-Tilt-Rotor-Flight-Control-and-Stability"local a,b,c,d=input,output,screen,math;local e,f,g,i=a.getNumber,b.setNumber,a.getBool,c.drawTextBox;local j,k,l,m,n,o=d.abs,d.sin,d.cos,d.max,d.pi;o=n*2;local function p(q,s,t)if q==nil then return nil end;if q>t then return t end;if q<s then return s end;return q end;local function u(...)local r={}for a,q in ipairs({...})do r[a]=e(q)end;return table.unpack(r)end;local function v(x)if x then return-1 end;return 1 end;local function y(x,z,A)if x then return z end;return A end;local B,C,D,E,F,G,H="altBuff","velBuff","accBuff","tgVelBuff","tgAccBuff","pitch","accErr"local function I()local J={ofs=nil,alt=0,tilt=0,vel=0,rot=0,pC=nil,pP=0,pR=0}J[H]=nil;J[G]=0.25;J[B]={}J[C]={}J[D]={}J[E]={}J[F]={}return J end;local K,L,M=1,2,3;local N,O,P,Q,_R,S,T,U,V=0,-1,K,0,{I(),I(),I(),I()}T=5;U=T+1;V=60/T;local W,X,Y,Z,_,a0,a1,a2={},1,2,3,4,5,6;a2={X,Y,Z,_,a0,a1}for a,q in pairs(a2)do W[q]={}end;local function a3(a4)for a5=1,T do a4[a5]=a4[a5+1]or 0 end end;local function a6(a7)return a7>0 and 1 or a7<0 and-1 or 0 end;local a8,a9,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq;function onTick()if e(1)==nil then return false end;N=N+1;if N==1 then end;a8,a9,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al=u(1,2,3,4,5,6,21,22,23,24,25,26,29,30)ap=0;aq=0+y(g(11),1,0)-y(g(12),1,0)if aj<0 then ah=ah+0.25*a6(aj)end;for a,q in pairs(a2)do a3(W[q])end;W[Z][U]=ag;W[X][U]=ai;W[Y][U]=ah;am=ag-W[Z][1]an=(ai-W[X][1])*V;ao=(ah-W[Z][1])*V;if am>.5 then am=am-1 end;if am<-.5 then am=am+1 end;am=am*V;for a,J in pairs(_R)do local r=J;local ar=(a-1)*3+9;J.alt,J.tilt,J.vel=u(ar,ar+1,ar+2)for as,a4 in pairs({B,C,D,E,F})do a3(J[a4])end;J.acc=J.vel-J.velBuff[1]J.velErr=J.vel-J[E][1]J[H]=J.acc-J[F][1]J[B][U]=J.alt;J[C][U]=J.vel;J[D][U]=J.acc;if J.ofs==nil and J.alt~=0 then J.ofs=J.alt end;ap=ap+J.alt;J.v2=(J.alt-J[B][1])*V end;ap=ap/4;if S==nil then if ap==0 then return false end;S=ap end;local at=0;if P==K then at=0.25;P=L end;if P==L then at=0.10;if ak>25 then P=M;S=ap+1;for a,r in pairs(_R)do r.ofs=r.alt-ap;r.tg=r.ofs+S;r.pC=0.25;r.conf=0;r.tv=0 end end end;local au,av=(ab*10)^2,(aa*10)^2;if ab<0 then au=au*-1 end;S=S+au/60;if aa<0 then av=av*-1 end;Q=p(Q+aq/(60*3),0,1)for a,J in pairs(_R)do local aw=p((aa+am*4)*0.25,-.25,.25)if a==2 or a==4 then aw=-aw end;J.rot=Q+aw;if P~=M then J[G]=at else local ax,ay,az,aA,aB,aC,aD,aE,aF,aG,aH,aI,aJ,aK,aL,aM,aN;ax=J.tilt*o;ay=l(ax)az=k(ax)aA=az/(ay+j(az))aB=1/az;if j(J.tilt)<0.06 then aB=0 else if j(J.tilt)<0.11 then aB=aB*m(j(J.tilt)-0.06,0)*1/0.05 end end;aH=J.v2;aI=J.vel*az;J.tg=J.alt+S-ap;aG=8;aC=p((J.tg-J.alt-aH*0.5)*aB,-aG,aG)aD=p(aC-J.vel,-2,2)aC=J.vel+aD;J.tv=aC;aJ=v(a<3)aK=36;aL=ah+ac;aE=p((a9*6+aL*aK)*aJ-J.vel*0.5,-0.25,12)aF=p(aE-J.vel,-2,2)aE=J.vel+aF;aJ=v(a==2 or a==4)local aO=36;aE=p((a8*6-ai*aO)*aJ-J.vel*0.5,-0.25,8)+aE;aF=p(aE-J.vel,-2,2)aE=J.vel+aF;J.tv=aC+aF;J.tgAcc=p(J.tv-J.vel,-10,10)aM=J.pC*aB+J.pC*0.1*J.tgAcc+Q*ad;aN=p(aM-J[G],-0.05,0.05)J[G]=J[G]+aN;J[E][U]=J.tv;J[F][U]=J.tgAcc;if J[H]<-1 then J.pC=p(J.pC+0.001*j(J[H])*0.5,0.1,0.6)J.conf=J.conf-0.01 end;if J[H]>4 then J.pC=p(J.pC-0.001*J[H]*0.5,0.1,0.6)J.conf=J.conf-0.01 end;if j(J[H])<0.5 then r.conf=r.conf+0.01 end end;f(a,J[G])f(a+4,J.rot)end;f(9,ap)f(10,S)end;local function aP(aQ)if aQ==nill then return"nil"end;return string.format("%.f",aQ)end;local function aR(aQ)if aQ==nill then return"nil"end;return string.format("%.2f",aQ)end;function onDraw()if al==nil then return false end;w=screen.getWidth()h=screen.getHeight()screen.setColor(255,0,0)tw=5*10;tx=20;ty=10;local function aS(aT,q)if ty+10>h then ty=10;tx=tx+tw*2.5 end;i(tx,ty,tw,6,aT,1,0)i(tx+tw+4,ty,tw*2,6,q,-1,0)ty=ty+6 end;tDiff=N-al;aS("State",P)aS("TickDiff",aR(tDiff))aS("rRPS",aR(ak))aS("qrAlt",aR(ap))aS("sCompass",aR(ag))aS("yawRate",aR(am))for a,r in pairs(_R)do aS(aP(a).."pColl",aR(r.pC))aS(aP(a).."Confdnc",aR(r.conf))aS("Vel",aR(r.vel))aS("Vel2",aR(r.v2))aS("vErr",aR(r.velErr))aS("aErr",aR(r[H]))end end